<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>H5 模板</title>
    <link rel="stylesheet" href="./template.css" />
  </head>
  <body class="h5-page" >
    <section id="hero" class="hero" aria-label="封面图"><img id="hero-img" class="hero-img" src="http://wuxicdn.oss-cn-beijing.aliyuncs.com/templates/690b569d77b26e1fcad4616d/529f9c3e1cf7-hero.png" alt="封面"/><div id="music" class="stopped" data-url="https://tyfy.oss-cn-beijing.aliyuncs.com/香云赞.mp3"><audio id="audio" loop="" preload="auto" autoplay="" playsinline="" src="https://tyfy.oss-cn-beijing.aliyuncs.com/香云赞.mp3"></audio><div class="control"><div class="control_after"></div></div></div></section><section id="slots" class="slots-section" aria-label="亮点时间"><div class="h5-header"><div class="section-label"><img src="http://wuxicdn.oss-cn-beijing.aliyuncs.com/templates/690b569d77b26e1fcad4616d/435854dfd9b2-icon-03.png" alt="" class="label-icon"/><span class="label-text">亮点时间</span></div></div><div id="msg" class="h5-message">加载中...</div><div id="slots-grid" class="slots-grid hidden"></div><input type="hidden" id="goods" name="goods" value=""/><input type="hidden" id="amount" name="amount" value=""/></section><section id="board" class="board-list"><div class="board-title">名单登记榜</div><div id="format-list" class="format-temp-list" data-auto-scroll="true" data-template="&lt;span class=&quot;temp-item-date&quot;&gt;${date2}&lt;/span&gt;&lt;span class=&quot;temp-item-name&quot;&gt;${name}&lt;/span&gt;&lt;span class=&quot;temp-item-goods&quot;&gt;${goods}&lt;/span&gt;&lt;span class=&quot;temp-item-value&quot;&gt;${amount}&lt;/span&gt;"></div></section><section id="consult" class="consult-section" aria-label="筹化咨询"><div class="consult-title" aria-hidden="true"><span>筹</span><span>化</span><span>咨</span><span>询</span></div><ul class="consult-list"><li>启安法师：<a href="tel:18662603022" aria-label="拨打启安法师电话">18662603022</a><span class="consult-note">（微信同步）</span></li><li>融心法师：<a href="tel:18036388996" aria-label="拨打融心法师电话">18036388996</a><span class="consult-note">（微信同步）</span></li><li>禅礼法师：<a href="tel:13862121255" aria-label="拨打禅礼法师电话">13862121255</a><span class="consult-note">（微信同步）</span></li></ul></section><div id="pay-mask" class="mask" aria-hidden="true"><div class="mask_content"><div class="input_panel1" style="display:block"><div class="input_panel2"><div class="title2"></div><div class="input_item juan_money"><span>金额：</span><input id="money" class="form-input" disabled=""/><span class="yuan">元</span></div><div class="input_item"><span>姓名：</span><input id="username" placeholder="自愿填写" class="form-input"/></div><div class="input_item"><span>电话：</span><input id="phone" placeholder="自愿填写" class="form-input"/></div><div class="input_item input-textarea"><span>留言：</span><textarea id="qifu" placeholder="自愿填写" class="form-input rich-text"></textarea></div><div class="operate"><div class="cancel" id="btn-cancel">取消</div><div class="confirm"><button type="button" class="mui-btn mui-btn-block gopay" id="btn-confirm">确定</button></div></div></div></div></div></div>
    <script>(function(){var LampTemplate=(()=>{var q=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var V=Object.prototype.hasOwnProperty;var Z=(o,u)=>{for(var E in u)q(o,E,{get:u[E],enumerable:!0})},ee=(o,u,E,w)=>{if(u&&typeof u=="object"||typeof u=="function")for(let C of X(u))!V.call(o,C)&&C!==E&&q(o,C,{get:()=>u[C],enumerable:!(w=W(u,C))||w.enumerable});return o};var te=o=>ee(q({},"__esModule",{value:!0}),o);var re={};Z(re,{attachLampRuntime:()=>D});function ne(o){return String(o||"").replace(/[~～至到\-]/g,"-").replace(/\s+/g,"").toLowerCase()}function S(o){let u=Number(o);return Number.isFinite(u)?u:0}function k(o){let u=ne(o);return/18.*20/.test(u),1}function D(){let o=document.getElementById("msg"),u=document.getElementById("slots-grid"),E=document.getElementById("format-list"),w=document.getElementById("music"),C=document.getElementById("audio"),c=document.getElementById("pay-mask"),N=document.getElementById("btn-cancel"),p=document.getElementById("btn-confirm"),R=document.getElementById("money"),M=document.getElementById("username"),x=document.getElementById("phone"),H=document.getElementById("qifu"),b=document.getElementById("goods"),T=document.getElementById("amount"),L={goods:[],selected:new Map,currency:"CNY"};function se(e,t){return(t||document).querySelector(e)}function A(e,t,r){let i=document.createElement(e);return t&&(i.className=t),r!=null&&(i.textContent=String(r)),i}function P(e,t){try{return new Intl.NumberFormat("zh-CN",{style:"currency",currency:t||"CNY",currencyDisplay:"narrowSymbol"}).format(S(e))}catch(r){return(t||"\xA5")+S(e).toFixed(2)}}function ie(e){return S(e).toFixed(2)+"\u5143"}function U(e){let t=new Date(e||Date.now()),r=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0");return r+"-"+i}function $(e){if(!e)return"\u533F\u540D";let t=String(e).trim();return t.length<=1?t+"**":t.length===2?t[0]+"*":t[0]+"**"}function B(){let e=new URLSearchParams(location.search);if(e.get("issueId"))return e.get("issueId");let t=location.pathname,r=[/\/h5\/([^\/?#]+)/,/\/artboard\/preview\/([^\/?#]+)/,/\/api\/preview\/([^\/?#]+)/,/\/client\/issues\/([^\/?#]+)\/goods/,/\/client\/issues\/([^\/?#]+)/,/\/client\/issues\/([^\/?#]+)\/edit/];for(let i of r){let n=t.match(i);if(n&&n[1])return decodeURIComponent(n[1])}return null}function O(){var r;if(!b||!T)return;let e=Array.from(L.selected.values()),t=e.reduce((i,n)=>i+S(n.price)*S(n.quantity),0);b.value=e.length?JSON.stringify({items:e,total:t,currency:((r=e[0])==null?void 0:r.currency)||L.currency||"CNY"}):"",T.value=e.length?String(t):"",window.dispatchEvent(new CustomEvent("goods:changed",{detail:{items:e,total:t,json:b.value}}))}function j(e){let t=typeof e.quantity=="number"?e.quantity:1/0,r=Number.isFinite(t)&&t<=0,i=A("div","slot-item"+(r?" slot-disabled":"")),n=A("div","slot-title",e.title||"");i.appendChild(n),r&&i.appendChild(A("div","slot-badge","\u5DF2\u6EE1"));let s=()=>{L.selected.has(e.id)?i.classList.add("selected"):i.classList.remove("selected")};return i.addEventListener("click",()=>{if(r)return;L.selected.clear(),document.querySelectorAll(".slot-item.selected").forEach(g=>g.classList.remove("selected"));let h=k(e.title);L.selected.set(e.id,{id:e.id,title:e.title,price:S(e.price),currency:e.currency||"CNY",quantity:h}),s(),O();let d=Number((T==null?void 0:T.value)||"0");R&&d>0&&(R.value=String(d.toFixed(2))),c==null||c.classList.add("show"),c==null||c.setAttribute("aria-hidden","false")}),i}function J(e){if(!u||!o)return;if(u.innerHTML="",!Array.isArray(e)||e.length===0){o.textContent="\u6682\u65E0\u5546\u54C1",o.classList.remove("hidden"),u.classList.add("hidden");return}o.classList.add("hidden"),u.classList.remove("hidden"),[...e].sort((r,i)=>{let n=/点/.test(r.title||"")?0:1,s=/点/.test(i.title||"")?0:1;return n!==s?n-s:(r.title||"").localeCompare(i.title||"","zh")}).forEach(r=>u.appendChild(j(r)))}function F(e){try{return e&&typeof e=="object"?e:typeof e=="string"?JSON.parse(e):null}catch(t){return null}}function z(e){let t=[],r=(e==null?void 0:e.formData)||{};if(r&&(r.goods||r.GOODS||r.Goods)){let n=F(r.goods||r.GOODS||r.Goods);if(n&&Array.isArray(n.items))return n.items.map(s=>({id:s.id,title:s.title,quantity:S(s.quantity)||1}))}if(typeof(e==null?void 0:e.goods1)=="string"){let n=F(e.goods1);if(n&&Array.isArray(n.items))return n.items.map(s=>({id:s.id,title:s.title,quantity:S(s.quantity)||1}));t.push({id:null,title:String(e.goods1),quantity:1})}typeof(e==null?void 0:e.goods2)=="string"&&t.push({id:null,title:String(e.goods2),quantity:1});let i=["time","timeSlot","\u65F6\u6BB5","\u4EAE\u706F\u65F6\u95F4","\u5546\u54C1"];for(let n of i)r[n]&&t.push({id:null,title:String(r[n]),quantity:1});return t}function _(e){if(!E)return;E.innerHTML="";let t=E.getAttribute("data-template")||'<span class="temp-item-name">${name}</span>: <span class="temp-item-value">${amount}</span>',r=(E.getAttribute("data-auto-scroll")||"true")==="true",n=e.filter(a=>(a.status||"").toUpperCase()==="PAID").map(a=>{let m=z(a)[0],y=typeof a.amount=="number"?a.amount:0,f=U(a.paidAt||a.createdAt),v=a.name||a.name1||a.formData&&(a.formData.name||a.formData.\u59D3\u540D||a.formData.\u79F0\u547C)||"";return{name:$(v),amount:P(y,"CNY"),date1:f,date2:f,goods:m?String(m.title):""}}),s=document.createElement("div");s.className="infinite-scroll";let d=(()=>{let a=document.createElement("ul");n.forEach(m=>{let y=document.createElement("li");y.innerHTML=t.replace(/\${(\w+)}/g,(f,v)=>m[v]||""),a.appendChild(y)});let l=document.createElement("li");return l.className="data-cycle-spacer",l.style.height="300px",l.style.background="transparent",l.style.border="none",l.style.padding="0",l.style.margin="0",l.style.listStyleType="none",a.appendChild(l),a})();if(s.appendChild(d),E.appendChild(s),!r)return;let g=d.offsetHeight,Y=Math.max(Math.ceil(s.offsetHeight/g)+2,3);for(let a=0;a<Y;a++){n.forEach(m=>{let y=document.createElement("li");y.innerHTML=t.replace(/\${(\w+)}/g,(f,v)=>m[v]||""),d.appendChild(y)});let l=document.createElement("li");l.className="data-cycle-spacer",l.style.height="300px",l.style.background="transparent",l.style.border="none",l.style.padding="0",l.style.margin="0",l.style.listStyleType="none",d.appendChild(l)}s.scrollTop=g,s.addEventListener("scroll",()=>{let a=s.scrollTop,l=d.offsetHeight-s.offsetHeight;if(a>l-g){n.forEach(y=>{let f=document.createElement("li");f.innerHTML=t.replace(/\${(\w+)}/g,(v,I)=>y[I]||""),d.appendChild(f)});let m=document.createElement("li");m.className="data-cycle-spacer",m.style.height="300px",m.style.background="transparent",m.style.border="none",m.style.padding="0",m.style.margin="0",m.style.listStyleType="none",d.appendChild(m);for(let y=0;y<n.length+1;y++)d.firstChild&&d.removeChild(d.firstChild);s.scrollTop=a-g}if(a<g){let m=[],y=document.createElement("li");y.className="data-cycle-spacer",y.style.height="300px",y.style.background="transparent",y.style.border="none",y.style.padding="0",y.style.margin="0",y.style.listStyleType="none",m.push(y);for(let f=n.length-1;f>=0;f--){let v=n[f],I=document.createElement("li");I.innerHTML=t.replace(/\${(\w+)}/g,(ae,Q)=>v[Q]||""),m.push(I)}m.forEach(f=>d.insertBefore(f,d.firstChild));for(let f=0;f<n.length+1;f++)d.lastChild&&d.removeChild(d.lastChild);s.scrollTop=a+g}}),setInterval(()=>{if(!s)return;let a=s.scrollTop,l=d.offsetHeight-s.offsetHeight;a>=l-10?s.scrollTop=g:s.scrollTop=a+1},50)}function G(){if(!w||!C)return;let e=w,t=C,r=e.getAttribute("data-url")||"";r&&!t.src&&(t.src=r);let i=!1;function n(d){d?e.classList.remove("stopped"):e.classList.add("stopped")}function s(){i?(t.pause(),n(!1)):t.play().then(()=>{i=!0,n(!0)}).catch(()=>{i=!1,n(!1)}),i=!i}let h=e.querySelector(".control");h==null||h.addEventListener("click",s),t.addEventListener("play",()=>{i=!0,n(!0)}),t.addEventListener("pause",()=>{i=!1,n(!1)}),document.addEventListener("WeixinJSBridgeReady",function(){t.play().then(()=>{i=!0,n(!0)})},!1),document.addEventListener("click",function(){i||t.play().then(()=>{i=!0,n(!0)})},{once:!0})}async function K(){var t;if(!o||!u)return;let e=B();if(!e){o.textContent="\u65E0\u6CD5\u8BC6\u522B\u9875\u9762 ID",o.classList.remove("hidden");return}o.textContent="\u52A0\u8F7D\u4E2D...",o.classList.remove("hidden"),u.classList.add("hidden"),L.selected.clear(),O();try{let[r,i]=await Promise.all([fetch(`/api/issues/${encodeURIComponent(e)}/goods`,{cache:"no-store"}),fetch(`/api/submissions?issueId=${encodeURIComponent(e)}`,{cache:"no-store"})]),n=r.ok?await r.json():[],s=i.ok?await i.json():{data:[]};L.goods=Array.isArray(n)?n:[],L.currency=((t=L.goods[0])==null?void 0:t.currency)||"CNY";let h=Array.isArray(s==null?void 0:s.data)?s.data:[];J(L.goods),_(h)}catch(r){console.error(r),o.textContent="\u52A0\u8F7D\u5931\u8D25\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5",o.classList.remove("hidden")}}N==null||N.addEventListener("click",()=>{c==null||c.classList.remove("show"),c==null||c.setAttribute("aria-hidden","true")}),c==null||c.addEventListener("click",e=>{e.target===c&&(c.classList.remove("show"),c.setAttribute("aria-hidden","true"))}),p==null||p.addEventListener("click",async()=>{try{p&&(p.disabled=!0);let e=Number((T==null?void 0:T.value)||"0");if(!e||e<=0){alert("\u8BF7\u9009\u62E9\u65F6\u95F4\u6BB5"),p&&(p.disabled=!1);return}let t=new URLSearchParams(location.search).get("openid"),r=B();if(!t){alert("\u65E0\u6CD5\u83B7\u53D6openid\uFF0C\u9700\u5728\u5FAE\u4FE1\u5185\u6253\u5F00"),p&&(p.disabled=!1);return}if(!r){alert("\u65E0\u6CD5\u8BC6\u522B\u9875\u9762ID"),p&&(p.disabled=!1);return}let i=b!=null&&b.value?JSON.parse(b.value):{items:[]},n={name:(M==null?void 0:M.value)||"",phone:(x==null?void 0:x.value)||"",qifu:(H==null?void 0:H.value)||""},s=await fetch("/api/payment/create-customer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({issueId:r,openid:t,formData:n,goods:b==null?void 0:b.value})});if(!s.ok){let g=await s.json().catch(()=>({error:"\u521B\u5EFA\u8BA2\u5355\u5931\u8D25"}));throw new Error(g.error||"\u521B\u5EFA\u8BA2\u5355\u5931\u8D25")}let h=await s.json(),d=window.wx;if(!d){alert("\u672A\u68C0\u6D4B\u5230\u5FAE\u4FE1JS SDK"),p&&(p.disabled=!1);return}d.chooseWXPay({timestamp:h.timeStamp,nonceStr:h.nonceStr,package:h.package,signType:h.signType,paySign:h.paySign,success:()=>{try{(i.items||[]).some(a=>{let l=L.goods.find(m=>m.id===a.id);return l&&Number(l.quantity)<=Number(a.quantity)})&&alert("\u60A8\u9009\u62E9\u7684\u65F6\u6BB5\u53EF\u80FD\u5DF2\u6EE1\uFF0C\u5DF2\u4E3A\u60A8\u5237\u65B0")}catch(g){}alert("\u652F\u4ED8\u6210\u529F"),location.reload()},fail:g=>{alert("\u652F\u4ED8\u5931\u8D25: "+g.errMsg)},complete:()=>{p&&(p.disabled=!1),c==null||c.classList.remove("show"),c==null||c.setAttribute("aria-hidden","true")}})}catch(e){alert("\u652F\u4ED8\u5931\u8D25,"+((e==null?void 0:e.message)||e||"\u8BF7\u91CD\u8BD5")),p&&(p.disabled=!1)}}),G(),K()}if(typeof window!="undefined")if(document.readyState==="complete"||document.readyState==="interactive")try{D()}catch(o){console.error(o)}else window.addEventListener("DOMContentLoaded",()=>{try{D()}catch(o){console.error(o)}});return te(re);})();
})();</script>
  </body>
</html>