<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>H5 模板</title>
    <link rel="stylesheet" href="./template.css" />
  </head>
  <body class="h5-page" >
    <section id="hero" class="hero" aria-label="封面图"><img id="hero-img" class="hero-img" src="https://kls.wxkltx.cn/api/image-assets/preview/1761977951391-xgm60d.jpg" alt="封面"/><div id="music" class="stopped" data-url="https://tyfy.oss-cn-beijing.aliyuncs.com/香云赞.mp3"><audio id="audio" loop="" preload="auto" autoplay="" playsinline="" src="https://tyfy.oss-cn-beijing.aliyuncs.com/香云赞.mp3"></audio><div class="control"><div class="control_after"></div></div></div></section><section id="slots" class="slots-section" aria-label="点灯时间"><div class="h5-header"><div class="section-label"><img src="/templates/assets/icon-03.png" alt="" class="label-icon"/><span class="label-text">点灯时间</span></div><button type="button" id="btn-refresh" class="h5-refresh" aria-label="刷新">刷新</button></div><div id="msg" class="h5-message">加载中...</div><div id="slots-grid" class="slots-grid hidden"></div><div id="summary" class="summary hidden"><span>合计 <strong id="total">¥0.00</strong></span><span><button id="btn-clear" class="h5-refresh" type="button">清空2</button><button id="btn-pay" class="h5-refresh" type="button" style="margin-left:8px;background:#111827;color:#fff;border-color:#111827">去支付</button></span></div><input type="hidden" id="goods" name="goods" value=""/><input type="hidden" id="amount" name="amount" value=""/></section><section id="board" class="board-list"><div class="board-title">名单登记榜</div><div id="format-list" class="format-temp-list" data-auto-scroll="true" data-template="&lt;span class=&quot;temp-item-date&quot;&gt;${date2}&lt;/span&gt;｜&lt;span class=&quot;temp-item-name&quot;&gt;${name}&lt;/span&gt;｜&lt;span class=&quot;temp-item-goods&quot;&gt;${goods}&lt;/span&gt;｜&lt;span class=&quot;temp-item-value&quot;&gt;${amount}&lt;/span&gt;"></div></section><div id="pay-mask" class="mask" aria-hidden="true"><div class="mask_content"><div class="input_panel1" style="display:block"><div class="input_panel2"><div class="title2"></div><div class="input_item"><span>金额：</span><input type="text" class="juan_money" id="money" disabled="" placeholder=""/><span class="yuan">元</span></div><div class="input_item"><span>姓名：</span><input type="text" id="username" placeholder="自愿填写"/></div><div class="input_item"><span>电话：</span><input type="text" id="phone" placeholder="自愿填写"/></div><div class="input_item" style="height:auto;align-items:flex-start;position:relative;display:block"><span>留言：</span><textarea id="qifu" placeholder="自愿填写"></textarea></div><div class="operate"><div class="cancel" id="btn-cancel">取消</div><div class="confirm"><button type="button" class="mui-btn mui-btn-block gopay" id="btn-confirm">确定</button></div></div></div></div></div></div>
    <script>(function(){var LampTemplate=(()=>{var O=Object.defineProperty;var ne=Object.getOwnPropertyDescriptor;var re=Object.getOwnPropertyNames;var se=Object.prototype.hasOwnProperty;var ie=(a,d)=>{for(var S in d)O(a,S,{get:d[S],enumerable:!0})},oe=(a,d,S,I)=>{if(d&&typeof d=="object"||typeof d=="function")for(let C of re(d))!se.call(a,C)&&C!==S&&O(a,C,{get:()=>d[C],enumerable:!(I=ne(d,C))||I.enumerable});return a};var ae=a=>oe(O({},"__esModule",{value:!0}),a);var le={};ie(le,{attachLampRuntime:()=>F});function k(a){return String(a||"").replace(/[~～至到\-]/g,"-").replace(/\s+/g,"").toLowerCase()}function b(a){let d=Number(a);return Number.isFinite(d)?d:0}function Y(a){let d=k(a);return/18.*20/.test(d),1}function F(){let a=document.getElementById("msg"),d=document.getElementById("slots-grid"),S=document.getElementById("total"),I=document.getElementById("summary"),C=document.getElementById("btn-clear"),H=document.getElementById("btn-refresh"),w=document.getElementById("format-list"),P=document.getElementById("music"),U=document.getElementById("audio"),x=document.getElementById("btn-pay"),c=document.getElementById("pay-mask"),q=document.getElementById("btn-cancel"),f=document.getElementById("btn-confirm"),$=document.getElementById("money"),A=document.getElementById("username"),D=document.getElementById("phone"),B=document.getElementById("qifu"),L=document.getElementById("goods"),v=document.getElementById("amount"),g={goods:[],selected:new Map,currency:"CNY"};function ce(e,t){return(t||document).querySelector(e)}function R(e,t,n){let r=document.createElement(e);return t&&(r.className=t),n!=null&&(r.textContent=String(n)),r}function j(e,t){try{return new Intl.NumberFormat("zh-CN",{style:"currency",currency:t||"CNY",currencyDisplay:"narrowSymbol"}).format(b(e))}catch(n){return(t||"\xA5")+b(e).toFixed(2)}}function de(e){return b(e).toFixed(2)+"\u5143"}function K(e){let t=new Date(e||Date.now()),n=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0");return n+"-"+r}function Q(e){if(!e)return"\u533F\u540D";let t=String(e).trim();return t.length<=1?t+"**":t.length===2?t[0]+"*":t[0]+"**"}function J(){let e=new URLSearchParams(location.search);if(e.get("issueId"))return e.get("issueId");let t=location.pathname,n=[/\/h5\/([^\/?#]+)/,/\/artboard\/preview\/([^\/?#]+)/,/\/api\/preview\/([^\/?#]+)/,/\/client\/issues\/([^\/?#]+)\/goods/,/\/client\/issues\/([^\/?#]+)/,/\/client\/issues\/([^\/?#]+)\/edit/];for(let r of n){let s=t.match(r);if(s&&s[1])return decodeURIComponent(s[1])}return null}function M(){var n,r;if(!I||!S||!L||!v)return;let e=Array.from(g.selected.values()),t=e.reduce((s,i)=>s+b(i.price)*b(i.quantity),0);e.length===0?(I.classList.add("hidden"),L.value="",v.value="",S.textContent="\xA50.00"):(I.classList.remove("hidden"),S.textContent=j(t,((n=e[0])==null?void 0:n.currency)||g.currency||"CNY"),L.value=JSON.stringify({items:e,total:t,currency:((r=e[0])==null?void 0:r.currency)||g.currency||"CNY"}),v.value=String(t)),window.dispatchEvent(new CustomEvent("goods:changed",{detail:{items:e,total:t,json:L.value}}))}function W(e){let t=typeof e.quantity=="number"?e.quantity:1/0,n=Number.isFinite(t)&&t<=0,r=R("div","slot-item"+(n?" slot-disabled":"")),s=R("div","slot-title",e.title||""),i=R("div","slot-badge"+(n?"":" ok"),n?"\u5DF2\u6EE1":"\u53EF\u9009");r.appendChild(s),r.appendChild(i);let p=()=>{g.selected.has(e.id)?r.classList.add("selected"):r.classList.remove("selected")};return p(),r.addEventListener("click",()=>{if(!n){if(g.selected.has(e.id))g.selected.delete(e.id);else{let u=Y(e.title);g.selected.set(e.id,{id:e.id,title:e.title,price:b(e.price),currency:e.currency||"CNY",quantity:u})}p(),M()}}),r}function X(e){if(!d||!a)return;if(d.innerHTML="",!Array.isArray(e)||e.length===0){a.textContent="\u6682\u65E0\u5546\u54C1",a.classList.remove("hidden"),d.classList.add("hidden");return}a.classList.add("hidden"),d.classList.remove("hidden");let t=[...e].sort((r,s)=>{let i=/点/.test(r.title||"")?0:1,p=/点/.test(s.title||"")?0:1;return i!==p?i-p:(r.title||"").localeCompare(s.title||"","zh")});t.forEach(r=>d.appendChild(W(r)));let n=t.find(r=>/18.*(点)?\D+20/.test(k(r.title)));if(n&&!g.selected.has(n.id)){g.selected.set(n.id,{id:n.id,title:n.title,price:b(n.price),currency:n.currency||"CNY",quantity:Y(n.title)}),M();let r=t.indexOf(n),s=d.children[r];s&&s.classList.add("selected")}}function z(e){try{return typeof e=="string"?JSON.parse(e):null}catch(t){return null}}function V(e){let t=[],n=(e==null?void 0:e.formData)||{};if(n&&(n.goods||n.GOODS||n.Goods)){let s=z(n.goods||n.GOODS||n.Goods);if(s&&Array.isArray(s.items))return s.items.map(i=>({id:i.id,title:i.title,quantity:b(i.quantity)||1}))}if(typeof(e==null?void 0:e.goods1)=="string"){let s=z(e.goods1);if(s&&Array.isArray(s.items))return s.items.map(i=>({id:i.id,title:i.title,quantity:b(i.quantity)||1}));t.push({id:null,title:String(e.goods1),quantity:1})}typeof(e==null?void 0:e.goods2)=="string"&&t.push({id:null,title:String(e.goods2),quantity:1});let r=["time","timeSlot","\u65F6\u6BB5","\u70B9\u706F\u65F6\u95F4","\u5546\u54C1"];for(let s of r)n[s]&&t.push({id:null,title:String(n[s]),quantity:1});return t}function Z(e){if(!w)return;w.innerHTML="";let t=w.getAttribute("data-template")||'<span class="temp-item-name">${name}</span>: <span class="temp-item-value">${amount}</span>',n=(w.getAttribute("data-auto-scroll")||"true")==="true",s=e.filter(o=>(o.status||"").toUpperCase()==="PAID").map(o=>{let m=V(o)[0],y=typeof o.amount=="number"?o.amount:0,h=K(o.paidAt||o.createdAt),T=o.name||o.name1||o.formData&&(o.formData.name||o.formData.\u59D3\u540D||o.formData.\u79F0\u547C)||"";return{name:Q(T),amount:j(y,"CNY"),date1:h,date2:h,goods:m?String(m.title):""}}),i=document.createElement("div");i.className="infinite-scroll";let u=(()=>{let o=document.createElement("ul");s.forEach(m=>{let y=document.createElement("li");y.innerHTML=t.replace(/\${(\w+)}/g,(h,T)=>m[T]||""),o.appendChild(y)});let l=document.createElement("li");return l.className="data-cycle-spacer",l.style.height="300px",l.style.background="transparent",l.style.border="none",l.style.padding="0",l.style.margin="0",l.style.listStyleType="none",o.appendChild(l),o})();if(i.appendChild(u),w.appendChild(i),!n)return;let E=u.offsetHeight,G=Math.max(Math.ceil(i.offsetHeight/E)+2,3);for(let o=0;o<G;o++){s.forEach(m=>{let y=document.createElement("li");y.innerHTML=t.replace(/\${(\w+)}/g,(h,T)=>m[T]||""),u.appendChild(y)});let l=document.createElement("li");l.className="data-cycle-spacer",l.style.height="300px",l.style.background="transparent",l.style.border="none",l.style.padding="0",l.style.margin="0",l.style.listStyleType="none",u.appendChild(l)}i.scrollTop=E,i.addEventListener("scroll",()=>{let o=i.scrollTop,l=u.offsetHeight-i.offsetHeight;if(o>l-E){s.forEach(y=>{let h=document.createElement("li");h.innerHTML=t.replace(/\${(\w+)}/g,(T,N)=>y[N]||""),u.appendChild(h)});let m=document.createElement("li");m.className="data-cycle-spacer",m.style.height="300px",m.style.background="transparent",m.style.border="none",m.style.padding="0",m.style.margin="0",m.style.listStyleType="none",u.appendChild(m);for(let y=0;y<s.length+1;y++)u.firstChild&&u.removeChild(u.firstChild);i.scrollTop=o-E}if(o<E){let m=[],y=document.createElement("li");y.className="data-cycle-spacer",y.style.height="300px",y.style.background="transparent",y.style.border="none",y.style.padding="0",y.style.margin="0",y.style.listStyleType="none",m.push(y);for(let h=s.length-1;h>=0;h--){let T=s[h],N=document.createElement("li");N.innerHTML=t.replace(/\${(\w+)}/g,(ue,te)=>T[te]||""),m.push(N)}m.forEach(h=>u.insertBefore(h,u.firstChild));for(let h=0;h<s.length+1;h++)u.lastChild&&u.removeChild(u.lastChild);i.scrollTop=o+E}}),setInterval(()=>{if(!i)return;let o=i.scrollTop,l=u.offsetHeight-i.offsetHeight;o>=l-10?i.scrollTop=E:i.scrollTop=o+1},50)}function ee(){if(!P||!U)return;let e=P,t=U,n=e.getAttribute("data-url")||"";n&&!t.src&&(t.src=n);let r=!1;function s(u){u?e.classList.remove("stopped"):e.classList.add("stopped")}function i(){r?(t.pause(),s(!1)):t.play().then(()=>{r=!0,s(!0)}).catch(()=>{r=!1,s(!1)}),r=!r}let p=e.querySelector(".control");p==null||p.addEventListener("click",i),t.addEventListener("play",()=>{r=!0,s(!0)}),t.addEventListener("pause",()=>{r=!1,s(!1)}),document.addEventListener("WeixinJSBridgeReady",function(){t.play().then(()=>{r=!0,s(!0)})},!1),document.addEventListener("click",function(){r||t.play().then(()=>{r=!0,s(!0)})},{once:!0})}async function _(){var t;if(!a||!d)return;let e=J();if(!e){a.textContent="\u65E0\u6CD5\u8BC6\u522B\u9875\u9762 ID",a.classList.remove("hidden");return}a.textContent="\u52A0\u8F7D\u4E2D...",a.classList.remove("hidden"),d.classList.add("hidden"),g.selected.clear(),M();try{let[n,r]=await Promise.all([fetch(`/api/issues/${encodeURIComponent(e)}/goods`,{cache:"no-store"}),fetch(`/api/submissions?issueId=${encodeURIComponent(e)}`,{cache:"no-store"})]),s=n.ok?await n.json():[],i=r.ok?await r.json():{data:[]};g.goods=Array.isArray(s)?s:[],g.currency=((t=g.goods[0])==null?void 0:t.currency)||"CNY";let p=Array.isArray(i==null?void 0:i.data)?i.data:[];X(g.goods),Z(p)}catch(n){console.error(n),a.textContent="\u52A0\u8F7D\u5931\u8D25\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5",a.classList.remove("hidden")}}C==null||C.addEventListener("click",()=>{g.selected.clear(),document.querySelectorAll(".slot-item.selected").forEach(e=>e.classList.remove("selected")),M()}),H==null||H.addEventListener("click",_),x==null||x.addEventListener("click",()=>{let e=Number((v==null?void 0:v.value)||"0");if(!e||e<=0){alert("\u8BF7\u9009\u62E9\u65F6\u95F4\u6BB5");return}$&&($.value=String(e.toFixed(2))),c==null||c.classList.add("show"),c==null||c.setAttribute("aria-hidden","false")}),q==null||q.addEventListener("click",()=>{c==null||c.classList.remove("show"),c==null||c.setAttribute("aria-hidden","true")}),c==null||c.addEventListener("click",e=>{e.target===c&&(c.classList.remove("show"),c.setAttribute("aria-hidden","true"))}),f==null||f.addEventListener("click",async()=>{try{f&&(f.disabled=!0);let e=Number((v==null?void 0:v.value)||"0");if(!e||e<=0){alert("\u8BF7\u9009\u62E9\u65F6\u95F4\u6BB5"),f&&(f.disabled=!1);return}let t=new URLSearchParams(location.search).get("openid"),n=J();if(!t){alert("\u65E0\u6CD5\u83B7\u53D6openid\uFF0C\u9700\u5728\u5FAE\u4FE1\u5185\u6253\u5F00"),f&&(f.disabled=!1);return}if(!n){alert("\u65E0\u6CD5\u8BC6\u522B\u9875\u9762ID"),f&&(f.disabled=!1);return}let r=L!=null&&L.value?JSON.parse(L.value):{items:[]},s={name:(A==null?void 0:A.value)||"",phone:(D==null?void 0:D.value)||"",qifu:(B==null?void 0:B.value)||""},i=await fetch("/api/payment/create-customer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({issueId:n,openid:t,formData:s,goods:L==null?void 0:L.value})});if(!i.ok){let E=await i.json().catch(()=>({error:"\u521B\u5EFA\u8BA2\u5355\u5931\u8D25"}));throw new Error(E.error||"\u521B\u5EFA\u8BA2\u5355\u5931\u8D25")}let p=await i.json(),u=window.wx;if(!u){alert("\u672A\u68C0\u6D4B\u5230\u5FAE\u4FE1JS SDK"),f&&(f.disabled=!1);return}u.chooseWXPay({timestamp:p.timeStamp,nonceStr:p.nonceStr,package:p.package,signType:p.signType,paySign:p.paySign,success:()=>{try{(r.items||[]).some(o=>{let l=g.goods.find(m=>m.id===o.id);return l&&Number(l.quantity)<=Number(o.quantity)})&&alert("\u60A8\u9009\u62E9\u7684\u65F6\u6BB5\u53EF\u80FD\u5DF2\u6EE1\uFF0C\u5DF2\u4E3A\u60A8\u5237\u65B0")}catch(E){}alert("\u652F\u4ED8\u6210\u529F"),location.reload()},fail:E=>{alert("\u652F\u4ED8\u5931\u8D25: "+E.errMsg)},complete:()=>{f&&(f.disabled=!1),c==null||c.classList.remove("show"),c==null||c.setAttribute("aria-hidden","true")}})}catch(e){alert("\u652F\u4ED8\u5931\u8D25,"+((e==null?void 0:e.message)||e||"\u8BF7\u91CD\u8BD5")),f&&(f.disabled=!1)}}),ee(),_()}if(typeof window!="undefined")if(document.readyState==="complete"||document.readyState==="interactive")try{F()}catch(a){console.error(a)}else window.addEventListener("DOMContentLoaded",()=>{try{F()}catch(a){console.error(a)}});return ae(le);})();
})();</script>
  </body>
</html>