<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>H5 模板</title>
    <link rel="stylesheet" href="./template.css" />
  </head>
  <body class="h5-page" style="padding:12px;">
    <section id="slots" aria-label="点灯时间"><div class="h5-header"><h2 class="h5-title">点灯时间2</h2><button type="button" id="btn-refresh" class="h5-refresh" aria-label="刷新">刷新</button></div><div id="msg" class="h5-message">加载中...</div><div id="slots-grid" class="slots-grid hidden"></div><div id="summary" class="summary hidden"><span>合计 <strong id="total">¥0.00</strong></span><span><button id="btn-clear" class="h5-refresh" type="button">清空2</button><button id="btn-pay" class="h5-refresh" type="button" style="margin-left:8px;background:#111827;color:#fff;border-color:#111827">去支付</button></span></div><input type="hidden" id="goods" name="goods" value=""/><input type="hidden" id="amount" name="amount" value=""/></section><section id="board" class="board"><div class="board-title">名单登记榜单</div><table class="board-table" aria-label="支付记录"><thead><tr><th class="board-col-date">日期</th><th class="board-col-name">姓名</th><th class="board-col-item">点灯时间</th><th class="board-col-amt">金额</th></tr></thead><tbody id="board-body"></tbody></table></section><div id="pay-mask" class="mask" aria-hidden="true"><div class="mask_content"><div class="input_panel1" style="display:block"><div class="input_panel2"><div class="title2"></div><div class="input_item"><span>金额：</span><input type="text" class="juan_money" id="money" disabled="" placeholder=""/><span class="yuan">元</span></div><div class="input_item"><span>姓名：</span><input type="text" id="username" placeholder="自愿填写"/></div><div class="input_item"><span>电话：</span><input type="text" id="phone" placeholder="自愿填写"/></div><div class="input_item" style="height:auto;align-items:flex-start;position:relative;display:block"><span>留言：</span><textarea id="qifu" placeholder="自愿填写"></textarea></div><div class="operate"><div class="cancel" id="btn-cancel">取消</div><div class="confirm"><button type="button" class="mui-btn mui-btn-block gopay" id="btn-confirm">确定</button></div></div></div></div></div></div>
    <script>(function(){var LampTemplate=(()=>{var q=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var W=Object.getOwnPropertyNames;var X=Object.prototype.hasOwnProperty;var V=(s,c)=>{for(var p in c)q(s,p,{get:c[p],enumerable:!0})},Z=(s,c,p,L)=>{if(c&&typeof c=="object"||typeof c=="function")for(let f of W(c))!X.call(s,f)&&f!==p&&q(s,f,{get:()=>c[f],enumerable:!(L=Q(c,f))||L.enumerable});return s};var _=s=>Z(q({},"__esModule",{value:!0}),s);var tt={};V(tt,{attachLampRuntime:()=>A});function M(s){return String(s||"").replace(/[~～至到\-]/g,"-").replace(/\s+/g,"").toLowerCase()}function y(s){let c=Number(s);return Number.isFinite(c)?c:0}function D(s){let c=M(s);return/18.*20/.test(c),1}function A(){let s=document.getElementById("msg"),c=document.getElementById("slots-grid"),p=document.getElementById("total"),L=document.getElementById("summary"),f=document.getElementById("btn-clear"),S=document.getElementById("btn-refresh"),C=document.getElementById("board-body"),I=document.getElementById("btn-pay"),a=document.getElementById("pay-mask"),w=document.getElementById("btn-cancel"),d=document.getElementById("btn-confirm"),H=document.getElementById("money"),T=document.getElementById("username"),N=document.getElementById("phone"),x=document.getElementById("qifu"),m=document.getElementById("goods"),g=document.getElementById("amount"),l={goods:[],selected:new Map,currency:"CNY"};function et(t,n){return(n||document).querySelector(t)}function h(t,n,e){let r=document.createElement(t);return n&&(r.className=n),e!=null&&(r.textContent=String(e)),r}function U(t,n){try{return new Intl.NumberFormat("zh-CN",{style:"currency",currency:n||"CNY",currencyDisplay:"narrowSymbol"}).format(y(t))}catch(e){return(n||"\xA5")+y(t).toFixed(2)}}function j(t){return y(t).toFixed(2)+"\u5143"}function k(t){let n=new Date(t||Date.now()),e=String(n.getMonth()+1).padStart(2,"0"),r=String(n.getDate()).padStart(2,"0");return e+"-"+r}function P(t){if(!t)return"\u533F\u540D";let n=String(t).trim();return n.length<=1?n+"**":n.length===2?n[0]+"*":n[0]+"**"}function B(){let t=new URLSearchParams(location.search);if(t.get("issueId"))return t.get("issueId");let n=location.pathname,e=[/\/h5\/([^\/?#]+)/,/\/artboard\/preview\/([^\/?#]+)/,/\/api\/preview\/([^\/?#]+)/,/\/client\/issues\/([^\/?#]+)\/goods/,/\/client\/issues\/([^\/?#]+)/,/\/client\/issues\/([^\/?#]+)\/edit/];for(let r of e){let i=n.match(r);if(i&&i[1])return decodeURIComponent(i[1])}return null}function v(){var e,r;if(!L||!p||!m||!g)return;let t=Array.from(l.selected.values()),n=t.reduce((i,o)=>i+y(o.price)*y(o.quantity),0);t.length===0?(L.classList.add("hidden"),m.value="",g.value="",p.textContent="\xA50.00"):(L.classList.remove("hidden"),p.textContent=U(n,((e=t[0])==null?void 0:e.currency)||l.currency||"CNY"),m.value=JSON.stringify({items:t,total:n,currency:((r=t[0])==null?void 0:r.currency)||l.currency||"CNY"}),g.value=String(n)),window.dispatchEvent(new CustomEvent("goods:changed",{detail:{items:t,total:n,json:m.value}}))}function z(t){let n=typeof t.quantity=="number"?t.quantity:1/0,e=Number.isFinite(n)&&n<=0,r=h("div","slot-item"+(e?" slot-disabled":"")),i=h("div","slot-title",t.title||""),o=h("div","slot-badge"+(e?"":" ok"),e?"\u5DF2\u6EE1":"\u53EF\u9009");r.appendChild(i),r.appendChild(o);let u=()=>{l.selected.has(t.id)?r.classList.add("selected"):r.classList.remove("selected")};return u(),r.addEventListener("click",()=>{if(!e){if(l.selected.has(t.id))l.selected.delete(t.id);else{let b=D(t.title);l.selected.set(t.id,{id:t.id,title:t.title,price:y(t.price),currency:t.currency||"CNY",quantity:b})}u(),v()}}),r}function J(t){if(!c||!s)return;if(c.innerHTML="",!Array.isArray(t)||t.length===0){s.textContent="\u6682\u65E0\u5546\u54C1",s.classList.remove("hidden"),c.classList.add("hidden");return}s.classList.add("hidden"),c.classList.remove("hidden");let n=[...t].sort((r,i)=>{let o=/点/.test(r.title||"")?0:1,u=/点/.test(i.title||"")?0:1;return o!==u?o-u:(r.title||"").localeCompare(i.title||"","zh")});n.forEach(r=>c.appendChild(z(r)));let e=n.find(r=>/18.*(点)?\D+20/.test(M(r.title)));if(e&&!l.selected.has(e.id)){l.selected.set(e.id,{id:e.id,title:e.title,price:y(e.price),currency:e.currency||"CNY",quantity:D(e.title)}),v();let r=n.indexOf(e),i=c.children[r];i&&i.classList.add("selected")}}function O(t){try{return typeof t=="string"?JSON.parse(t):null}catch(n){return null}}function G(t){let n=[],e=(t==null?void 0:t.formData)||{};if(e&&(e.goods||e.GOODS||e.Goods)){let i=O(e.goods||e.GOODS||e.Goods);if(i&&Array.isArray(i.items))return i.items.map(o=>({id:o.id,title:o.title,quantity:y(o.quantity)||1}))}if(typeof(t==null?void 0:t.goods1)=="string"){let i=O(t.goods1);if(i&&Array.isArray(i.items))return i.items.map(o=>({id:o.id,title:o.title,quantity:y(o.quantity)||1}));n.push({id:null,title:String(t.goods1),quantity:1})}typeof(t==null?void 0:t.goods2)=="string"&&n.push({id:null,title:String(t.goods2),quantity:1});let r=["time","timeSlot","\u65F6\u6BB5","\u70B9\u706F\u65F6\u95F4","\u5546\u54C1"];for(let i of r)e[i]&&n.push({id:null,title:String(e[i]),quantity:1});return n}function K(t){if(!C)return;C.innerHTML="",t.filter(e=>(e.status||"").toUpperCase()==="PAID").forEach(e=>{let r=document.createElement("tr"),o=G(e)[0],u=typeof e.amount=="number"?e.amount:0;r.appendChild(h("td","board-col-date",k(e.paidAt||e.createdAt)));let b=e.name||e.name1||e.formData&&(e.formData.name||e.formData.\u59D3\u540D||e.formData.\u79F0\u547C)||"";r.appendChild(h("td","board-col-name",P(b))),r.appendChild(h("td","board-col-item",o?String(o.title):"\u2014")),r.appendChild(h("td","board-col-amt",j(u))),C.appendChild(r)})}async function R(){var n;if(!s||!c)return;let t=B();if(!t){s.textContent="\u65E0\u6CD5\u8BC6\u522B\u9875\u9762 ID",s.classList.remove("hidden");return}s.textContent="\u52A0\u8F7D\u4E2D...",s.classList.remove("hidden"),c.classList.add("hidden"),l.selected.clear(),v();try{let[e,r]=await Promise.all([fetch(`/api/issues/${encodeURIComponent(t)}/goods`,{cache:"no-store"}),fetch(`/api/submissions?issueId=${encodeURIComponent(t)}`,{cache:"no-store"})]),i=e.ok?await e.json():[],o=r.ok?await r.json():{data:[]};l.goods=Array.isArray(i)?i:[],l.currency=((n=l.goods[0])==null?void 0:n.currency)||"CNY";let u=Array.isArray(o==null?void 0:o.data)?o.data:[];J(l.goods),K(u)}catch(e){console.error(e),s.textContent="\u52A0\u8F7D\u5931\u8D25\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5",s.classList.remove("hidden")}}f==null||f.addEventListener("click",()=>{l.selected.clear(),document.querySelectorAll(".slot-item.selected").forEach(t=>t.classList.remove("selected")),v()}),S==null||S.addEventListener("click",R),I==null||I.addEventListener("click",()=>{let t=Number((g==null?void 0:g.value)||"0");if(!t||t<=0){alert("\u8BF7\u9009\u62E9\u65F6\u95F4\u6BB5");return}H&&(H.value=String(t.toFixed(2))),a==null||a.classList.add("show"),a==null||a.setAttribute("aria-hidden","false")}),w==null||w.addEventListener("click",()=>{a==null||a.classList.remove("show"),a==null||a.setAttribute("aria-hidden","true")}),a==null||a.addEventListener("click",t=>{t.target===a&&(a.classList.remove("show"),a.setAttribute("aria-hidden","true"))}),d==null||d.addEventListener("click",async()=>{try{d&&(d.disabled=!0);let t=Number((g==null?void 0:g.value)||"0");if(!t||t<=0){alert("\u8BF7\u9009\u62E9\u65F6\u95F4\u6BB5"),d&&(d.disabled=!1);return}let n=new URLSearchParams(location.search).get("openid"),e=B();if(!n){alert("\u65E0\u6CD5\u83B7\u53D6openid\uFF0C\u9700\u5728\u5FAE\u4FE1\u5185\u6253\u5F00"),d&&(d.disabled=!1);return}if(!e){alert("\u65E0\u6CD5\u8BC6\u522B\u9875\u9762ID"),d&&(d.disabled=!1);return}let r=m!=null&&m.value?JSON.parse(m.value):{items:[]},i={name:(T==null?void 0:T.value)||"",phone:(N==null?void 0:N.value)||"",qifu:(x==null?void 0:x.value)||""},o=await fetch("/api/payment/create-customer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({issueId:e,openid:n,formData:i,goods:m==null?void 0:m.value})});if(!o.ok){let E=await o.json().catch(()=>({error:"\u521B\u5EFA\u8BA2\u5355\u5931\u8D25"}));throw new Error(E.error||"\u521B\u5EFA\u8BA2\u5355\u5931\u8D25")}let u=await o.json(),b=window.wx;if(!b){alert("\u672A\u68C0\u6D4B\u5230\u5FAE\u4FE1JS SDK"),d&&(d.disabled=!1);return}b.chooseWXPay({timestamp:u.timeStamp,nonceStr:u.nonceStr,package:u.package,signType:u.signType,paySign:u.paySign,success:()=>{try{(r.items||[]).some(Y=>{let F=l.goods.find($=>$.id===Y.id);return F&&Number(F.quantity)<=Number(Y.quantity)})&&alert("\u60A8\u9009\u62E9\u7684\u65F6\u6BB5\u53EF\u80FD\u5DF2\u6EE1\uFF0C\u5DF2\u4E3A\u60A8\u5237\u65B0")}catch(E){}alert("\u652F\u4ED8\u6210\u529F"),location.reload()},fail:E=>{alert("\u652F\u4ED8\u5931\u8D25: "+E.errMsg)},complete:()=>{d&&(d.disabled=!1),a==null||a.classList.remove("show"),a==null||a.setAttribute("aria-hidden","true")}})}catch(t){alert("\u652F\u4ED8\u5931\u8D25,"+((t==null?void 0:t.message)||t||"\u8BF7\u91CD\u8BD5")),d&&(d.disabled=!1)}}),R()}if(typeof window!="undefined")if(document.readyState==="complete"||document.readyState==="interactive")try{A()}catch(s){console.error(s)}else window.addEventListener("DOMContentLoaded",()=>{try{A()}catch(s){console.error(s)}});return _(tt);})();
})();</script>
  </body>
</html>